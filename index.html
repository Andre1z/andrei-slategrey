<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Editor Multimedia Profesional</title>
  <!-- Se enlaza la hoja de estilos original -->
  <link rel="stylesheet" href="css/estilo.css">
</head>
<body>
  <h1><img src="slategrey.png" alt="slategrey logo"> jocarsa | slategrey</h1>

  <div id="container">

    <!-- TOP PANEL: Botones y Time Display (Scrubber) -->
    <div id="topPanelSingleRow">
      <button id="btnOpenMonitor">Open Monitor</button>
      <button id="btnOpenParams">Open Parameters</button>
      <button id="btnSaveProject">Guardar Proyecto</button>
      <button id="btnLoadProject">Cargar Proyecto</button>
      <!-- Input oculto para cargar archivo JSON -->
      <input type="file" id="fileInput" style="display:none;" accept=".json">
      
      <!-- Time Display: ahora es interactivo, contiene la aguja roja y el valor de tiempo -->
      <div id="time-display">
        <div id="time-needle"></div>
        <span id="time-value">Tiempo actual: 00:00</span>
      </div>
    </div>

    <!-- BOTTOM PANEL -->
    <div id="bottomPanel">
      <!-- Escala de tiempo (Time Scale) -->
      <div id="timeScale"></div>

      <!-- Container de Pistas (Tracks) -->
      <div id="tracksContainer">
        <!-- Pista de Video 1 -->
        <div class="trackRow">
          <div class="trackLabel">V1</div>
          <div id="trackVideo1" class="track"
               ondragover="event.preventDefault();"
               ondrop="handleFileDrop(event, 'video1')">
            <!-- Aquí se agregarán los clips para V1 -->
          </div>
        </div>
        <!-- Pista de Video 2 -->
        <div class="trackRow">
          <div class="trackLabel">V2</div>
          <div id="trackVideo2" class="track"
               ondragover="event.preventDefault();"
               ondrop="handleFileDrop(event, 'video2')">
            <!-- Clips para V2 -->
          </div>
        </div>
        <!-- Pista de Audio -->
        <div class="trackRow">
          <div class="trackLabel">A</div>
          <div id="trackAudio" class="track"
               ondragover="event.preventDefault();"
               ondrop="handleFileDrop(event, 'audio')">
            <!-- Clips para Audio -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PANEL DE TRANSICIONES Y EFECTOS -->
  <div id="transitionsPanel">
    <h2>Transiciones y Efectos</h2>
    <div id="transitionItem" draggable="true" data-type="crossfade">
      Crossfade (1s)
    </div>
  </div>

  <!-- Inclusión de scripts externos -->
  <script src="js/codigo.php"></script>
  <script src="js/funciones/transitions.js"></script>
  <script src="js/funciones/createTrackClip.js"></script>
  <script src="js/funciones/decodeAudioFile.js"></script>
  <script src="js/funciones/doRender.js"></script>
  <script src="js/funciones/drawAudioWaveform.js"></script>
  <script src="js/funciones/drawClipsAtTime.js"></script>
  <script src="js/funciones/drawTimeScale.js"></script>
  <script src="js/funciones/fileToArrayBuffer.js"></script>
  <script src="js/funciones/getTimelineMaxTime.js"></script>
  <script src="js/funciones/handleFileDrop.js"></script>
  <script src="js/funciones/moveTimeCursorTo.js"></script>
  <script src="js/funciones/onClipMoveMouseMove.js"></script>
  <script src="js/funciones/onClipMoveMouseUp.js"></script>
  <script src="js/funciones/onHandleResizeMove.js"></script>
  <script src="js/funciones/onHandleResizeUp.js"></script>
  <script src="js/funciones/playbackLoop.js"></script>
  <script src="js/funciones/scheduleAllAudio.js"></script>
  <script src="js/funciones/setPreviewTime.js"></script>
  <script src="js/funciones/startClipMove.js"></script>
  <script src="js/funciones/startHandleResize.js"></script>
  <script src="js/funciones/stepFrames.js"></script>
  <script src="js/funciones/updatePreviewAtTime.js"></script>
  <script src="js/funciones/updatePreviewUI.js"></script>

  <!-- Script inline: Controles globales y scrubber -->
  <script>
    "use strict";
    
    // Variable global para el tiempo en la secuencia concatenada.
    var currentGlobalTime = 0;
    // Variable global para el clip actualmente seleccionado.
    window.selectedClip = null;
    
    // Formatea un número de segundos en un string "mm:ss"
    function formatTime(seconds) {
      var min = Math.floor(seconds / 60);
      var sec = Math.floor(seconds % 60);
      return ("0" + min).slice(-2) + ":" + ("0" + sec).slice(-2);
    }
    
    // Dada una posición global (en segundos), devuelve el clip y la posición local.
    function getClipFromGlobalTime(globalTime) {
      var tracksContainer = document.getElementById("tracksContainer");
      var clips = tracksContainer.querySelectorAll(".track-clip");
      var cumulative = 0;
      for (var i = 0; i < clips.length; i++) {
        var duration = parseFloat(clips[i].dataset.duration);
        if (globalTime >= cumulative && globalTime <= cumulative + duration) {
          return { clip: clips[i], localTime: globalTime - cumulative };
        }
        cumulative += duration;
      }
      return null;
    }
    
    // Convierte el tiempo local de un clip a tiempo global.
    function getGlobalTimeFromClip(clipElem, localTime) {
      var tracksContainer = document.getElementById("tracksContainer");
      var clips = tracksContainer.querySelectorAll(".track-clip");
      var cumulative = 0;
      for (var i = 0; i < clips.length; i++) {
        if (clips[i] === clipElem) {
          return cumulative + localTime;
        }
        cumulative += parseFloat(clips[i].dataset.duration);
      }
      return cumulative;
    }
    
    // Función central: cambia la posición del scrubber y sincroniza la preview.
    window.setNeedleTime = function(newGlobalTime) {
      currentGlobalTime = newGlobalTime;
      var pps = 50; // Valor de PIXELS_PER_SECOND (definido en codigo.php)
      var newLeft = newGlobalTime * pps;
      document.getElementById("time-needle").style.left = newLeft + "px";
      document.getElementById("time-value").textContent = "Tiempo actual: " + formatTime(newGlobalTime) + " s";
      
      var clipData = getClipFromGlobalTime(newGlobalTime);
      if (clipData) {
        var clip = clipData.clip, localTime = clipData.localTime;
        if (window.selectedClip !== clip) {
          var allClips = document.querySelectorAll(".track-clip");
          allClips.forEach(function(c) { c.classList.remove("selected"); });
          clip.classList.add("selected");
          window.selectedClip = clip;
          loadClipIntoPreview(clip, localTime);
        } else {
          window.selectedClip.currentScrubTime = localTime;
          if (window.selectedClip.dataset.fileType && window.selectedClip.dataset.fileType.startsWith("video/")) {
            var previewVideo = document.getElementById("preview-video");
            if (previewVideo) previewVideo.currentTime = localTime;
          }
        }
      }
    };
    
    // Eventos para el scrubber: arrastrar la aguja y hacer clic en el área.
    (function(){
      var timeDisplay = document.getElementById("time-display");
      var needle = document.getElementById("time-needle");
      var isDragging = false, startX = 0, startGlobalT = 0;
      
      function getPPS() { return 50; }
      
      needle.addEventListener("mousedown", function(e) {
        isDragging = true;
        startX = e.clientX;
        startGlobalT = needle.offsetLeft / getPPS();
        e.preventDefault();
      });
      
      document.addEventListener("mousemove", function(e) {
        if (isDragging) {
          var deltaX = e.clientX - startX;
          var newTime = startGlobalT + (deltaX / getPPS());
          if (newTime < 0) newTime = 0;
          window.setNeedleTime(newTime);
        }
      });
      
      document.addEventListener("mouseup", function() {
        isDragging = false;
      });
      
      timeDisplay.addEventListener("click", function(e) {
        if (e.target === needle) return;
        var rect = timeDisplay.getBoundingClientRect();
        var clickX = e.clientX - rect.left;
        window.setNeedleTime(clickX / getPPS());
      });
    })();
    
    // Controles de reproducción: Play, Pause, Reset y Step Frames basados en el scrubber.
    (function(){
      var playbackInterval = null;
      window.playbackLoop = function() {
        if (playbackInterval) return;
        playbackInterval = setInterval(function(){
          var step = 1/30;
          var newTime = currentGlobalTime + step;
          window.setNeedleTime(newTime);
        }, 33);
      };
      
      window.stopPlayback = function() {
        if (playbackInterval) {
          clearInterval(playbackInterval);
          playbackInterval = null;
        }
      };
      
      window.resetPlayback = function() {
        window.stopPlayback();
        window.setNeedleTime(0);
      };
      
      window.stepFrames = function(direction) {
        var step = 1/30;
        var newTime = currentGlobalTime + (direction * step);
        if (newTime < 0) newTime = 0;
        window.setNeedleTime(newTime);
      };
    })();
    
    // Función para "fit" la timeline (ajusta el zoom para ver toda la secuencia)
    function fitTimeline() {
      var tracksContainer = document.getElementById("tracksContainer");
      var clips = tracksContainer.querySelectorAll(".track-clip");
      var totalDuration = 0;
      clips.forEach(function(clip) {
        totalDuration += parseFloat(clip.dataset.duration);
      });
      var containerWidth = tracksContainer.clientWidth;
      var newPps = containerWidth / totalDuration;
      clips.forEach(function(clip) {
        var duration = parseFloat(clip.dataset.duration);
        clip.style.width = (duration * newPps) + "px";
      });
      if (typeof drawTimeMarkers === "function") drawTimeMarkers();
    }
    window.fitTimeline = fitTimeline;
  </script>
  
  <!-- Script para redimensión de clips -->
  <script src="js/funciones/startHandleResize.js"></script>
  <script src="js/funciones/onHandleResizeMove.js"></script>
  <script src="js/funciones/onHandleResizeUp.js"></script>
  
</body>
</html>