<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Editor Multimedia – Timeline y Preview</title>
  <!-- Enlace a la hoja de estilos ubicada en css/estilo.css -->
  <link rel="stylesheet" href="css/estilo.css">
</head>
<body>
  <h1>Editor Multimedia</h1>
  
  <!-- Zona para arrastrar y soltar archivos (para agregar clips a la timeline) -->
  <div id="clip-drop-area" ondragover="event.preventDefault()" ondrop="handleClipDrop(event)">
    Arrastra y suelta archivos en la zona de clips
  </div>
  
  <!-- Timeline: aquí se agregarán dinámicamente los clips -->
  <div id="timeline-container" data-pixels-per-second="10">
    <!-- Los elementos con clase "track-clip" se agregarán aquí -->
  </div>
  
  <!-- Vista Previa: se carga el clip seleccionado -->
  <div id="preview-container">
    <!-- Elemento para video -->
    <video id="preview-video" width="640" height="360" controls style="display: none;"></video>
    <!-- Elemento para imagen -->
    <img id="preview-image" alt="Preview de imagen" style="display: none;">
    <!-- Elemento canvas para audio (opcional) -->
    <canvas id="preview-canvas" width="640" height="360" style="display: none;"></canvas>
  </div>
  
  <!-- Display para mostrar la duración o tiempo actual -->
  <div id="time-display">Tiempo actual: 00:00</div>
  
  <!-- Controles de reproducción -->
  <div id="controls">
    <button onclick="playbackLoop()">Play</button>
    <button onclick="stopPlayback()">Pause</button>
    <button onclick="resetPlayback()">Reset</button>
    <button onclick="stepFrames(-1)">Step Back</button>
    <button onclick="stepFrames(1)">Step Forward</button>
    <button onclick="togglePopOutPreview()">Pop-out Preview</button>
  </div>
  
  <!-- Inclusión de módulos JavaScript (ruta: js/funciones/) -->
  <script src="js/funciones/createTrackClip.js"></script>
  <script src="js/funciones/decodeAudioFile.js"></script>
  <script src="js/funciones/doRender.js"></script>
  <script src="js/funciones/drawAudioWaveform.js"></script>
  <script src="js/funciones/drawClipsAtTime.js"></script>
  <script src="js/funciones/drawTimeScale.js"></script>
  <script src="js/funciones/fileToArrayBuffer.js"></script>
  <script src="js/funciones/getTimelineMaxTime.js"></script>
  <script src="js/funciones/handleFileDrop.js"></script>
  <script src="js/funciones/moveTimeCursorTo.js"></script>
  <script src="js/funciones/onClipMoveMouseMove.js"></script>
  <script src="js/funciones/onClipMoveMouseUp.js"></script>
  <script src="js/funciones/onHandleResizeMove.js"></script>
  <script src="js/funciones/onHandleResizeUp.js"></script>
  <script src="js/funciones/playbackLoop.js"></script>
  <script src="js/funciones/scheduleAllAudio.js"></script>
  <script src="js/funciones/setPreviewTime.js"></script>
  <script src="js/funciones/startClipMove.js"></script>
  <script src="js/funciones/startHandleResize.js"></script>
  <script src="js/funciones/stepFrames.js"></script>
  <script src="js/funciones/transitions.js"></script>
  <script src="js/funciones/updatePreviewAtTime.js"></script>
  <script src="js/funciones/updatePreviewUI.js"></script>
  
  <!-- Script inline para manejar la carga de múltiples archivos en la timeline -->
  <script>
    "use strict";
    
    // Función para formatear tiempo a "mm:ss"
    function formatTime(seconds) {
      var min = Math.floor(seconds / 60);
      var sec = Math.floor(seconds % 60);
      return ("0" + min).slice(-2) + ":" + ("0" + sec).slice(-2);
    }
    
    /**
     * Maneja el evento "drop" únicamente para la zona de clips (en la timeline).
     * Permite agregar múltiples archivos (video, imagen o audio) a la timeline.
     */
    function handleClipDrop(event) {
      event.preventDefault();
      event.stopPropagation();
      var files = event.dataTransfer.files;
      if (!files || files.length === 0) {
        console.warn("No se han arrastrado archivos.");
        return;
      }
      // Procesa cada archivo
      for (var i = 0; i < files.length; i++) {
        var file = files[i];
        // Procesa solo videos, imágenes o audio
        if (file.type.startsWith("video/") ||
            file.type.startsWith("image/") ||
            file.type.startsWith("audio/")) {
          addClipToTimeline(file);
        } else {
          console.warn("Tipo de archivo no soportado: " + file.type);
        }
      }
    }
    
    /**
     * Agrega un nuevo clip a la timeline a partir de un archivo.
     * Se crea un elemento con clase "track-clip" que se muestra en la timeline.
     */
    function addClipToTimeline(file) {
      var timeline = document.getElementById("timeline-container");
      var clipElem = document.createElement("div");
      clipElem.className = "track-clip";
      
      // Crear URL para el archivo usando URL.createObjectURL
      var fileURL = URL.createObjectURL(file);
      // Almacenar datos en dataset para usarlos luego
      clipElem.dataset.fileType = file.type;
      clipElem.dataset.fileURL = fileURL;
      clipElem.dataset.fileName = file.name;
      
      // Para la vista en la timeline simplemente se muestra un texto
      if (file.type.startsWith("video/")) {
        clipElem.textContent = "Video: " + file.name;
      } else if (file.type.startsWith("image/")) {
        clipElem.textContent = "Imagen: " + file.name;
      } else if (file.type.startsWith("audio/")) {
        clipElem.textContent = "Audio: " + file.name;
      } else {
        clipElem.textContent = file.name;
      }
      
      // Al hacer clic en el clip, se carga en la vista previa
      clipElem.addEventListener("click", function() {
        // Quitar la clase "selected" de otros clips
        var clips = document.querySelectorAll(".track-clip");
        for (var j = 0; j < clips.length; j++) {
          clips[j].classList.remove("selected");
        }
        clipElem.classList.add("selected");
        loadClipIntoPreview(clipElem);
      });
      
      timeline.appendChild(clipElem);
    }
    
    /**
     * Carga el clip seleccionado en el contenedor de vista previa.
     * Dependiendo del tipo (video, imagen, audio) se muestra el elemento correspondiente.
     */
    function loadClipIntoPreview(clipElem) {
      var type = clipElem.dataset.fileType;
      var url = clipElem.dataset.fileURL;
      var previewVideo = document.getElementById("preview-video");
      var previewImage = document.getElementById("preview-image");
      var previewCanvas = document.getElementById("preview-canvas");
      
      // Ocultar todos los elementos de preview
      previewVideo.style.display = "none";
      previewImage.style.display = "none";
      previewCanvas.style.display = "none";
      
      if (type.startsWith("video/")) {
        previewVideo.src = url;
        previewVideo.style.display = "block";
        previewVideo.load();
        // Al cargar los metadatos, muestra la duración
        previewVideo.addEventListener("loadedmetadata", function() {
          document.getElementById("time-display").textContent = "Duración del video: " + formatTime(previewVideo.duration);
        });
      } else if (type.startsWith("image/")) {
        previewImage.src = url;
        previewImage.style.display = "block";
        document.getElementById("time-display").textContent = "Imagen: " + clipElem.dataset.fileName;
      } else if (type.startsWith("audio/")) {
        document.getElementById("time-display").textContent = "Audio: " + clipElem.dataset.fileName;
        previewCanvas.style.display = "block";
        // Aquí podrías agregar la función para dibujar la forma de onda, si la implementas.
      }
    }
    
    // Asignar la función de drop para la zona de clips
    window.handleClipDrop = handleClipDrop;
  </script>
  
  <!-- Script inline para controles de reproducción adaptados al elemento de preview -->
  <script>
    "use strict";
    function playbackLoop() {
      var previewVideo = document.getElementById("preview-video");
      if (previewVideo && previewVideo.style.display !== "none") {
        previewVideo.play();
      }
    }
    function stopPlayback() {
      var previewVideo = document.getElementById("preview-video");
      if (previewVideo && previewVideo.style.display !== "none") {
        previewVideo.pause();
      }
    }
    function resetPlayback() {
      var previewVideo = document.getElementById("preview-video");
      if (previewVideo && previewVideo.style.display !== "none") {
        previewVideo.pause();
        previewVideo.currentTime = 0;
        document.getElementById("time-display").textContent = "Tiempo actual: 00:00";
      }
    }
    function stepFrames(direction) {
      var previewVideo = document.getElementById("preview-video");
      if (previewVideo && previewVideo.style.display !== "none") {
        var fps = 30; // valor por defecto
        var step = 1.0 / fps;
        var newTime = previewVideo.currentTime + direction * step;
        if (newTime < 0) newTime = 0;
        if (previewVideo.duration && newTime > previewVideo.duration) newTime = previewVideo.duration;
        previewVideo.currentTime = newTime;
        document.getElementById("time-display").textContent = "Tiempo actual: " + formatTime(newTime);
      }
    }
    var popOutWindow = null;
    function togglePopOutPreview() {
      var previewContainer = document.getElementById("preview-container");
      var previewVideo = document.getElementById("preview-video");
      if (!previewVideo || previewVideo.style.display === "none") {
        alert("No hay video de previsualización para separar.");
        return;
      }
      if (!popOutWindow || popOutWindow.closed) {
        popOutWindow = window.open("", "PreviewWindow", "width=800,height=600");
        popOutWindow.document.write("<html><head><title>Preview</title></head><body style='margin:0;'></body></html>");
        previewContainer.removeChild(previewVideo);
        popOutWindow.document.body.appendChild(previewVideo);
      } else {
        popOutWindow.document.body.removeChild(previewVideo);
        previewContainer.appendChild(previewVideo);
        popOutWindow.close();
        popOutWindow = null;
      }
    }
    
    window.playbackLoop = playbackLoop;
    window.stopPlayback = stopPlayback;
    window.resetPlayback = resetPlayback;
    window.stepFrames = stepFrames;
    window.togglePopOutPreview = togglePopOutPreview;
  </script>
  
</body>
</html>