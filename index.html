<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Editor Multimedia – Preview de Vídeo</title>
  <!-- Enlace a la hoja de estilos -->
  <link rel="stylesheet" href="css/estilo.css">
</head>
<body>
  <h1>Editor Multimedia</h1>
  
  <!-- Área para arrastrar y soltar archivos -->
  <div id="file-drop-area" ondragover="event.preventDefault()" ondrop="handleFileDrop(event)">
    Arrastra y suelta archivos aquí
  </div>
  
  <!-- Contenedor para la previsualización (video) -->
  <div id="preview-container">
    <video id="preview-video" width="320" height="240" controls style="display: none;"></video>
    <!-- Alternativamente, se pueden usar el canvas o la imagen para audio o imágenes -->
    <canvas id="preview-canvas" width="320" height="240" style="display: none;"></canvas>
    <img id="preview-image" alt="Preview de imagen" style="display: none;" />
  </div>
  
  <!-- Display para mostrar el tiempo actual o la duración del video -->
  <div id="time-display">Tiempo actual: 00:00</div>
  
  <!-- Contenedor de la Timeline (ahora ubicado debajo de la duración del video) -->
  <div id="timeline-container" data-pixels-per-second="10">
    <div id="time-cursor"></div>
  </div>
  
  <!-- Controles de reproducción -->
  <div id="controls">
    <button onclick="playbackLoop()">Play</button>
    <button onclick="stopPlayback()">Pause</button>
    <button onclick="resetPlayback()">Reset</button>
    <button onclick="stepFrames(-1)">Step Back</button>
    <button onclick="stepFrames(1)">Step Forward</button>
    <button onclick="togglePopOutPreview()">Pop-out Preview</button>
  </div>
  
  <!-- Inclusión de módulos JavaScript desde js/funciones/ -->
  <script src="js/funciones/createTrackClip.js"></script>
  <script src="js/funciones/decodeAudioFile.js"></script>
  <script src="js/funciones/doRender.js"></script>
  <script src="js/funciones/drawAudioWaveform.js"></script>
  <script src="js/funciones/drawClipsAtTime.js"></script>
  <script src="js/funciones/drawTimeScale.js"></script>
  <script src="js/funciones/fileToArrayBuffer.js"></script>
  <script src="js/funciones/getTimelineMaxTime.js"></script>
  <script src="js/funciones/handleFileDrop.js"></script>
  <script src="js/funciones/moveTimeCursorTo.js"></script>
  <script src="js/funciones/onClipMoveMouseMove.js"></script>
  <script src="js/funciones/onClipMoveMouseUp.js"></script>
  <script src="js/funciones/onHandleResizeMove.js"></script>
  <script src="js/funciones/onHandleResizeUp.js"></script>
  <script src="js/funciones/playbackLoop.js"></script>
  <script src="js/funciones/scheduleAllAudio.js"></script>
  <script src="js/funciones/setPreviewTime.js"></script>
  <script src="js/funciones/startClipMove.js"></script>
  <script src="js/funciones/startHandleResize.js"></script>
  <script src="js/funciones/stepFrames.js"></script>
  <script src="js/funciones/transitions.js"></script>
  <script src="js/funciones/updatePreviewAtTime.js"></script>
  <script src="js/funciones/updatePreviewUI.js"></script>
  
  <!-- Script inline para sobreescribir funciones de reproducción y agregar pop-out -->
  <script>
    "use strict";
    
    /**
     * Función auxiliar para formatear tiempo (mm:ss)
     * @param {number} seconds - Tiempo en segundos.
     * @returns {string} Tiempo formateado.
     */
    function formatTime(seconds) {
      var min = Math.floor(seconds / 60);
      var sec = Math.floor(seconds % 60);
      return ("0" + min).slice(-2) + ":" + ("0" + sec).slice(-2);
    }
    
    // Control de reproducción sobre el video
    function playbackLoop() {
      var previewVideo = document.getElementById("preview-video");
      if (previewVideo && previewVideo.style.display !== "none") {
        previewVideo.play();
      } else if (typeof window.playbackLoop === "function") {
        window.playbackLoop();
      }
    }
    
    function stopPlayback() {
      var previewVideo = document.getElementById("preview-video");
      if (previewVideo && previewVideo.style.display !== "none") {
        previewVideo.pause();
      } else if (typeof window.stopPlayback === "function") {
        window.stopPlayback();
      }
    }
    
    function resetPlayback() {
      var previewVideo = document.getElementById("preview-video");
      if (previewVideo && previewVideo.style.display !== "none") {
        previewVideo.pause();
        previewVideo.currentTime = 0;
        document.getElementById("time-display").textContent = "Tiempo actual: 00:00";
      } else if (typeof window.resetPlayback === "function") {
        window.resetPlayback();
      }
    }
    
    function stepFrames(direction) {
      var previewVideo = document.getElementById("preview-video");
      if (previewVideo && previewVideo.style.display !== "none") {
        var fps = 30; // valor por defecto
        var step = 1.0 / fps;
        var newTime = previewVideo.currentTime + direction * step;
        if (newTime < 0) newTime = 0;
        if (newTime > previewVideo.duration) newTime = previewVideo.duration;
        previewVideo.currentTime = newTime;
        document.getElementById("time-display").textContent = "Tiempo actual: " + formatTime(newTime);
      } else if (typeof window.stepFrames === "function") {
        window.stepFrames(direction);
      }
    }
    
    // Funcionalidad "pop-out preview": permite sacar el video a otra ventana y luego reintegrarlo.
    var popOutWindow = null;
    function togglePopOutPreview() {
      var previewContainer = document.getElementById("preview-container");
      var previewVideo = document.getElementById("preview-video");
      if (!previewVideo || previewVideo.style.display === "none") {
        alert("No hay video de previsualización para separar.");
        return;
      }
      
      if (!popOutWindow || popOutWindow.closed) {
        // Pop out: mover el video a una nueva ventana.
        popOutWindow = window.open("", "PreviewWindow", "width=400,height=300");
        popOutWindow.document.write("<html><head><title>Preview</title></head><body style='margin:0;'></body></html>");
        // Mueve el video al nuevo documento.
        previewContainer.removeChild(previewVideo);
        popOutWindow.document.body.appendChild(previewVideo);
      } else {
        // Reintegrar: volver a poner el video en el contenedor original y cerrar la ventana.
        popOutWindow.document.body.removeChild(previewVideo);
        previewContainer.appendChild(previewVideo);
        popOutWindow.close();
        popOutWindow = null;
      }
    }
    
    // Se sobreescriben las funciones globales para que los botones llamen a las versiones aquí definidas.
    window.playbackLoop = playbackLoop;
    window.stopPlayback = stopPlayback;
    window.resetPlayback = resetPlayback;
    window.stepFrames = stepFrames;
    window.togglePopOutPreview = togglePopOutPreview;
  </script>
  
  <!-- Script inline para manejo de drop (actualizado para videos, imágenes y audio) -->
  <script>
    (function() {
      "use strict";
      
      /**
       * Maneja el evento "drop" para archivos.
       * Para archivos de video:
       *  - Se asigna la URL al elemento <video> de previsualización.
       *  - Al cargar los metadatos, se actualiza el display con la duración del video.
       * Para imágenes y audio se aplican los manejos respectivos.
       *
       * @param {DragEvent} event - El evento drop.
       */
      function handleFileDrop(event) {
        event.preventDefault();
        event.stopPropagation();
  
        var files = event.dataTransfer.files;
        if (!files || files.length === 0) {
          console.warn("No se han arrastrado archivos.");
          return;
        }
  
        for (var i = 0; i < files.length; i++) {
          var file = files[i];
          console.log("Archivo soltado:", file.name, file.type);
  
          // Manejo para archivos de video
          if (file.type.startsWith("video/")) {
            var previewVideo = document.getElementById("preview-video");
            if (previewVideo) {
              previewVideo.src = URL.createObjectURL(file);
              previewVideo.style.display = "block";
              previewVideo.load();
  
              // Ocultar otros elementos de previsualización:
              var previewImage = document.getElementById("preview-image");
              if (previewImage) previewImage.style.display = "none";
              var previewCanvas = document.getElementById("preview-canvas");
              if (previewCanvas) previewCanvas.style.display = "none";
  
              // Actualizar el display con la duración al cargar metadatos:
              previewVideo.addEventListener("loadedmetadata", function() {
                var duration = previewVideo.duration;
                var timeDisplay = document.getElementById("time-display");
                if (timeDisplay) {
                  timeDisplay.textContent = "Duración del video: " + formatTime(duration);
                }
              });
            }
          }
          // Manejo para archivos de imagen
          else if (file.type.startsWith("image/")) {
            var reader = new FileReader();
            reader.onload = function(e) {
              var previewImage = document.getElementById("preview-image");
              if (previewImage) {
                previewImage.src = e.target.result;
                previewImage.style.display = "block";
              }
              if (document.getElementById("preview-canvas"))
                document.getElementById("preview-canvas").style.display = "none";
              if (document.getElementById("preview-video"))
                document.getElementById("preview-video").style.display = "none";
            };
            reader.readAsDataURL(file);
          }
          // Manejo para archivos de audio
          else if (file.type.startsWith("audio/")) {
            if (typeof decodeAudioFile === "function") {
              decodeAudioFile(file)
                .then(function(audioBuffer) {
                  var waveformCanvas = document.getElementById("preview-canvas");
                  if (waveformCanvas && typeof drawAudioWaveform === "function") {
                    waveformCanvas.style.display = "block";
                    var previewImage = document.getElementById("preview-image");
                    if (previewImage) previewImage.style.display = "none";
                    var previewVideo = document.getElementById("preview-video");
                    if (previewVideo) previewVideo.style.display = "none";
  
                    drawAudioWaveform(audioBuffer, waveformCanvas);
                  }
                })
                .catch(function(error) {
                  console.error("Error al decodificar el audio:", error);
                });
            } else {
              console.error("Función decodeAudioFile no definida.");
            }
          }
          else {
            console.warn("Tipo de archivo no soportado: " + file.type);
          }
        }
      }
      
      window.handleFileDrop = handleFileDrop;
    })();
  </script>
  
  <!-- Inicialización tras cargar el DOM -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Actualizar la previsualización (por ejemplo, la posición del cursor en la timeline)
      updatePreviewUI();
    });
  </script>
</body>
</html>