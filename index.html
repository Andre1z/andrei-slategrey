<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Editor Multimedia - Drag & Drop Preview</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #fafafa;
      margin: 0;
      padding: 0;
    }
    h1 {
      text-align: center;
      margin-top: 20px;
    }
    /* Contenedor de la línea de tiempo */
    #timeline-container {
      position: relative;
      width: 800px;
      height: 80px;
      margin: 20px auto;
      border: 1px solid #ccc;
      background-color: #f4f4f4;
    }
    /* Cursor de la línea de tiempo */
    #time-cursor {
      position: absolute;
      top: 0;
      width: 2px;
      height: 100%;
      background-color: red;
      left: 100px; /* Valor inicial para demostrar */
    }
    /* Display para mostrar el tiempo actual */
    #time-display {
      text-align: center;
      font-size: 18px;
      margin: 10px;
    }
    /* Controles de reproducción */
    #controls {
      text-align: center;
      margin: 10px;
    }
    #controls button {
      padding: 8px 12px;
      margin: 0 5px;
      font-size: 16px;
      cursor: pointer;
    }
    /* Área de drag & drop */
    #file-drop-area {
      border: 2px dashed #aaa;
      width: 400px;
      margin: 20px auto;
      padding: 20px;
      text-align: center;
      color: #777;
      background-color: #fff;
    }
    /* Estilos para la previsualización */
    #preview-canvas, #preview-video, #preview-image {
      display: block;
      margin: 20px auto;
      max-width: 320px;
      border: 1px solid #ccc;
    }
    #preview-canvas, #preview-video {
      display: none;
    }
    #preview-image {
      display: none;
    }
  </style>
</head>
<body>
  <h1>Editor Multimedia</h1>
  
  <!-- Contenedor de la línea de tiempo -->
  <div id="timeline-container" data-pixels-per-second="10">
    <div id="time-cursor"></div>
  </div>
  
  <!-- Display del tiempo actual -->
  <div id="time-display">Tiempo actual: 00:00</div>
  
  <!-- Controles de reproducción -->
  <div id="controls">
    <button onclick="playbackLoop()">Play</button>
    <button onclick="stopPlayback()">Pause</button>
    <button onclick="resetPlayback()">Reset</button>
    <button onclick="stepFrames(-1)">Step Back</button>
    <button onclick="stepFrames(1)">Step Forward</button>
  </div>
  
  <!-- Área para soltar archivos -->
  <div id="file-drop-area" ondragover="event.preventDefault()" ondrop="handleFileDrop(event)">
    Arrastra y suelta archivos aquí
  </div>
  
  <!-- Elementos para previsualización -->
  <!-- Previsualización de video -->
  <video id="preview-video" width="320" height="240" controls></video>
  <!-- Previsualización de audio (por ejemplo, forma de onda en canvas) -->
  <canvas id="preview-canvas" width="320" height="240"></canvas>
  <!-- Previsualización de imagen -->
  <img id="preview-image" alt="Preview de imagen" />
  
  <!-- Inclusión de módulos JavaScript (se asume que estos archivos existen y funcionan) -->
  <script src="js/funciones/createTrackClip.js"></script>
  <script src="js/funciones/decodeAudioFile.js"></script>
  <script src="js/funciones/doRender.js"></script>
  <script src="js/funciones/drawAudioWaveform.js"></script>
  <script src="js/funciones/drawClipsAtTime.js"></script>
  <script src="js/funciones/drawTimeScale.js"></script>
  <script src="js/funciones/fileToArrayBuffer.js"></script>
  <script src="js/funciones/getTimelineMaxTime.js"></script>
  <!-- Usamos el handleFileDrop actualizado a continuación -->
  <script>
  (function() {
    "use strict";

    /**
     * Maneja el evento "drop" para archivos.
     * Según el tipo de archivo, se realiza una acción:
     * - Imagen: se lee como Data URL y se asigna al elemento de previsualización "preview-image".
     * - Audio: se decodifica (usando decodeAudioFile) y se renderiza la forma de onda en "preview-canvas".
     * - Video: se crea una URL del objeto y se asigna a "preview-video".
     */
    function handleFileDrop(event) {
      event.preventDefault();
      event.stopPropagation();

      var files = event.dataTransfer.files;
      if (!files || files.length === 0) {
        console.warn("No se han arrastrado archivos.");
        return;
      }

      // Itera sobre los archivos soltados.
      for (var i = 0; i < files.length; i++) {
        var file = files[i];
        console.log("Archivo soltado:", file.name, file.type);

        // Si es imagen.
        if (file.type.startsWith("image/")) {
          var reader = new FileReader();
          reader.onload = function(e) {
            var previewImage = document.getElementById("preview-image");
            if (previewImage) {
              previewImage.src = e.target.result;
              previewImage.style.display = "block";
            }
            // Ocultar otras previsualizaciones.
            var previewCanvas = document.getElementById("preview-canvas");
            if (previewCanvas) previewCanvas.style.display = "none";
            var previewVideo = document.getElementById("preview-video");
            if (previewVideo) previewVideo.style.display = "none";
          };
          reader.readAsDataURL(file);
        }
        // Si es audio.
        else if (file.type.startsWith("audio/")) {
          if (typeof decodeAudioFile === "function") {
            decodeAudioFile(file)
              .then(function(audioBuffer) {
                console.log("Audio decodificado:", audioBuffer);
                var waveformCanvas = document.getElementById("preview-canvas");
                if (waveformCanvas && typeof drawAudioWaveform === "function") {
                  waveformCanvas.style.display = "block";
                  // Ocultar otros elementos.
                  var previewImage = document.getElementById("preview-image");
                  if (previewImage) previewImage.style.display = "none";
                  var previewVideo = document.getElementById("preview-video");
                  if (previewVideo) previewVideo.style.display = "none";

                  drawAudioWaveform(audioBuffer, waveformCanvas);
                }
              })
              .catch(function(error) {
                console.error("Error al decodificar el audio:", error);
              });
          } else {
            console.error("Función decodeAudioFile no definida.");
          }
        }
        // Si es video.
        else if (file.type.startsWith("video/")) {
          var previewVideo = document.getElementById("preview-video");
          if (previewVideo) {
            previewVideo.src = URL.createObjectURL(file);
            previewVideo.style.display = "block";
            // Ocultar otros elementos.
            var previewImage = document.getElementById("preview-image");
            if (previewImage) previewImage.style.display = "none";
            var previewCanvas = document.getElementById("preview-canvas");
            if (previewCanvas) previewCanvas.style.display = "none";
          }
        }
        else {
          console.warn("Tipo de archivo no soportado: " + file.type);
        }
      }
    }
    window.handleFileDrop = handleFileDrop;
  })();
  </script>
  <!-- Resto de archivos JS -->
  <script src="js/funciones/createTrackClip.js"></script>
  <script src="js/funciones/decodeAudioFile.js"></script>
  <script src="js/funciones/doRender.js"></script>
  <script src="js/funciones/drawAudioWaveform.js"></script>
  <script src="js/funciones/drawClipsAtTime.js"></script>
  <script src="js/funciones/drawTimeScale.js"></script>
  <script src="js/funciones/fileToArrayBuffer.js"></script>
  <script src="js/funciones/getTimelineMaxTime.js"></script>
  <script src="js/funciones/handleFileDrop.js"></script>
  <script src="js/funciones/moveTimeCursorTo.js"></script>
  <script src="js/funciones/onClipMoveMouseMove.js"></script>
  <script src="js/funciones/onClipMoveMouseUp.js"></script>
  <script src="js/funciones/onHandleResizeMove.js"></script>
  <script src="js/funciones/onHandleResizeUp.js"></script>
  <script src="js/funciones/playbackLoop.js"></script>
  <script src="js/funciones/scheduleAllAudio.js"></script>
  <script src="js/funciones/setPreviewTime.js"></script>
  <script src="js/funciones/startClipMove.js"></script>
  <script src="js/funciones/startHandleResize.js"></script>
  <script src="js/funciones/stepFrames.js"></script>
  <script src="js/funciones/transitions.js"></script>
  <script src="js/funciones/updatePreviewAtTime.js"></script>
  <script src="js/funciones/updatePreviewUI.js"></script>
  
  <!-- Inicialización tras cargar el DOM -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Actualiza la previsualización según el cursor actual
      updatePreviewUI();
      // Aquí podrías invocar otros ajustes iniciales, p.ej.: scheduleAllAudio();
    });
  </script>
</body>
</html>